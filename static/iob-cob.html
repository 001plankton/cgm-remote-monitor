

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nightscout: IOB</title>
    <link href="/images/round1.png" rel="icon" id="favicon" type="image/png" />
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <style type="text/css">
        table tr td {
            white-space: nowrap;
        }
    </style>
    <script src="/bower_components/angularjs/angular.min.js"></script>
    <script type="text/javascript">
        'use strict';

        var app = angular.module('ns-treatments', []);

        app.controller('TreatmentsController', function ($scope, $http, $timeout, visibility) {
            var pageIsHidden = false;

            function update() {
                console.info("update called");
                if (pageIsHidden) {
                    console.info('Not updating, since page is hidden');
                } else {
                    console.info('Updating, since page is visible');
                    $http.get('/api/v1/treatments').success(function(treatments) {
                        $scope.treatments = treatments.slice(0, 500);
                        $scope.iobTotal = iobTotal(treatments.slice(0, 100));
                        $scope.cobTotal = cobTotal(treatments.slice(0, 100));
                    });
                    $http.get('/api/v1/profile').success(function(profile) {
                        $scope.profile = profile.slice(0, 500);
			console.info(profile);
                    });
                }
            }

            $scope.$on('visibilityChanged', function(event, isHidden) {
                console.info('changed pageIsHidden to ' + isHidden);
                pageIsHidden = isHidden;
                if (!pageIsHidden) update();
            });

            function startUpdateCycle() {
                update();
                $timeout(startUpdateCycle, 20 * 1000);
            }

            startUpdateCycle();

            $scope.glucoseDisplay = function(treatment) {
                if (treatment.glucose)
                    return treatment.glucose + (treatment.glucoseType ? ' (' + treatment.glucoseType + ')' : '');
                else
                    return '';
            }

            function iobTotal(treatments) {
                var iob= 0;
                var activity = 0;
                if (!treatments) return {};

                treatments.forEach(function(treatment) {
                    var tIOB = $scope.iob(treatment);
                    if (tIOB && tIOB.iobcontrib) iob += tIOB.iobcontrib;
                    if (tIOB && tIOB.activitycontrib) activity += tIOB.activitycontrib;
                });
                return {
                    iob: iob,
                    activity: activity
                };
            }

            function cobTotal(treatments) {
                var cob=0;
                if (!treatments) return {};
                var curtime = new Date();
                var lastdecayedby = new Date("1/1/1970");

                treatments.reverse();

                treatments.forEach(function(treatment) {
                    if(treatment.carbs) {
                        var tCOB = $scope.cob(treatment, lastdecayedby);
                        if (tCOB) {
                            lastdecayedby = tCOB.decayedby;
                            if (tCOB.carbsleft) {
                                var carbsleft = + tCOB.carbsleft;
                            }
                        }

                        var carbs_hr = $scope.profile[0].carbs_hr;
                        var decaysin_hr = (lastdecayedby-curtime)/1000/60/60;
                        if (decaysin_hr > 0) {
                            cob = Math.min(tCOB.initialcarbs, decaysin_hr * carbs_hr);
                        }
                        else { cob = 0; }
//console.info( "cob: " + cob );
                    }
                });
                return {
                    decayedby: lastdecayedby,
                    cob: cob
                };
            }

            $scope.cob = function(treatment, lastdecayedby) {

                var carbs_hr = $scope.profile[0].carbs_hr;
                var delay = 20;
                var carbs_min = carbs_hr / 60;
                        

                if (treatment.carbs) {
                    var carbtime = new Date(treatment.created_at);

                    var decayedby = new Date(carbtime);
                    var minutesleft = (lastdecayedby-carbtime)/1000/60;
                    decayedby.setMinutes (decayedby.getMinutes() + Math.max(delay,minutesleft) + treatment.carbs/carbs_min); 
                    if(delay > minutesleft) { var initialcarbs = treatment.carbs; }
                    else { var initialcarbs = treatment.carbs + minutesleft*carbs_min; }
                    return {
                        initialcarbs: initialcarbs,
                        decayedby: decayedby,
                        carbtime: carbtime
                    };
                }
                else {
                    return '';
                }
            }

            $scope.iob = function(treatment) {

                var dia=$scope.profile[0].dia;
                if (dia == 3) {
                    var peak=75;
                } else {
                    console.warn('DIA of ' + dia + 'not supported');
                }
                var sens=$scope.profile[0].sens;
                var curtime=new Date();

                if (treatment.insulin) {
                    var bolustime=new Date(treatment.created_at);
                    var minago=(curtime-bolustime)/1000/60;

                    if (minago < 0) { 
                        var iobcontrib=0;
                        var activitycontrib=0;
                    }
                    if (minago < peak) {
                        var x = minago/5+1;
                        var iobcontrib=treatment.insulin*(1-0.001852*x*x+0.001852*x);
                        var activitycontrib=sens*treatment.insulin*(2/dia/60/peak)*minago;

                    }
                    else if (minago < 180) {
                        var x = (minago-75)/5;
                        var iobcontrib=treatment.insulin*(0.001323*x*x - .054233*x + .55556);
                        var activitycontrib=sens*treatment.insulin*(2/dia/60-(minago-peak)*2/dia/60/(60*dia-peak));
                    }
                    else {
                        var iobcontrib=0;
                        var activitycontrib=0;
                    }
                    //iob = iob + iobcontrib;
                    //activity = activity + activitycontrib;
                    return {
                        iobcontrib: iobcontrib,
                        activitycontrib: activitycontrib
                    };
                }
                else {
                    return '';
                }
            }

        });

        app.service('visibility', function visibility($rootScope) {
            function visibilityChanged() {
                $rootScope.$broadcast('visibilityChanged', !!(document.hidden || document.webkitHidden || document.mozHidden || document.msHidden));
            }

            document.addEventListener('webkitvisibilitychange', visibilityChanged);
        });

    </script>

</head>
<body ng-app="ns-treatments">
<div class="container" ng-controller="TreatmentsController">
    <h3>Nightscout: IOB</h3>
    <p>Total COB (g): {{cobTotal.cob | number: 1}}</p>
    <p>All carbs decayed by: {{cobTotal.decayedby | date:'short'}}</p>
    <p>Total IOB (U): {{iobTotal.iob | number: 2}}</p>
    <p>Current Insulin Activity (BG impact in mg/dL/min): {{iobTotal.activity | number: 2}} ({{iobTotal.activity*5 | number: 2}} mg/dL per 5 min)</p>
    <table class="table table-striped table-hover">
        <thead>
        <tr>
            <td>Time</td>
            <td>BG (mg/dL)</td>
            <td>Insulin (U)</td>
            <td>Carbs (g)</td>
            <td>IOB (U)</td>
            <td>Insulin Act. (mg/dL/min)</td>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="treatment in treatments">
            <td>{{treatment.created_at | date:'short'}}</td>
            <td>{{glucoseDisplay(treatment)}}</td>
            <td>{{treatment.insulin | number: 2}}</td>
            <td>{{treatment.carbs}}</td>
            <td>{{iob(treatment).iobcontrib | number: 2}}</td>
            <td>{{iob(treatment).activitycontrib | number: 2}}</td>
        </tr>
        </tbody>
    </table>
</div>
</body>
</html>
